# GitHub Actions - PM ë¬¸ì„œ ìë™í™” ì›Œí¬í”Œë¡œìš°
# ì´ íŒŒì¼ì„ .github/workflows/ ë””ë ‰í† ë¦¬ì— ë³µì‚¬í•˜ì—¬ ì‚¬ìš©

name: ğŸ¤– PM ë¬¸ì„œ ìë™ ì—…ë°ì´íŠ¸

on:
  # í‰ì¼ ì˜¤ì „ 9ì‹œì— ìë™ ì‹¤í–‰
  schedule:
    - cron: '0 9 * * 1-5'
  
  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:
    inputs:
      completion_percentage:
        description: 'í”„ë¡œì íŠ¸ ì™„ì„±ë„ (%)'
        required: false
        default: ''
      daily_only:
        description: 'ì¼ì¼ ìŠ¤íƒ ë“œì—…ë§Œ ìƒì„±'
        type: boolean
        required: false
        default: false

jobs:
  update-pm-docs:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: ğŸ Python ì„¤ì •
        uses: actions/setup-python@v4
        with:
          python-version: '3.9'
          cache: 'pip'
      
      - name: ğŸ“¦ ì˜ì¡´ì„± ì„¤ì¹˜
        run: |
          python -m pip install --upgrade pip
          # í•„ìš”í•œ íŒ¨í‚¤ì§€ê°€ ìˆë‹¤ë©´ ì—¬ê¸°ì— ì¶”ê°€
          
      - name: ğŸ” ìŠ¤í¬ë¦½íŠ¸ ì¡´ì¬ í™•ì¸
        run: |
          if [ ! -f "docs/pm/09_automation/update_scripts.py" ]; then
            echo "âŒ PM ìë™í™” ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            exit 1
          fi
          echo "âœ… PM ìë™í™” ìŠ¤í¬ë¦½íŠ¸ í™•ì¸ë¨"
      
      - name: ğŸ¤– PM ë¬¸ì„œ ì—…ë°ì´íŠ¸ ì‹¤í–‰
        run: |
          cd ${{ github.workspace }}
          
          # ì…ë ¥ íŒŒë¼ë¯¸í„°ì— ë”°ë¼ ë‹¤ë¥¸ ëª…ë ¹ ì‹¤í–‰
          if [ "${{ github.event.inputs.daily_only }}" == "true" ]; then
            echo "ğŸ“… ì¼ì¼ ìŠ¤íƒ ë“œì—…ë§Œ ìƒì„±í•©ë‹ˆë‹¤..."
            python docs/pm/09_automation/update_scripts.py -d
          elif [ -n "${{ github.event.inputs.completion_percentage }}" ]; then
            echo "ğŸ“Š ì™„ì„±ë„ ${{ github.event.inputs.completion_percentage }}%ë¡œ ë¬¸ì„œë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤..."
            python docs/pm/09_automation/update_scripts.py -c ${{ github.event.inputs.completion_percentage }}
          else
            echo "ğŸ”„ ëª¨ë“  PM ë¬¸ì„œë¥¼ ì—…ë°ì´íŠ¸í•©ë‹ˆë‹¤..."
            python docs/pm/09_automation/update_scripts.py
          fi
      
      - name: ğŸ“‹ ë³€ê²½ì‚¬í•­ í™•ì¸
        id: check_changes
        run: |
          if [ -z "$(git status --porcelain)" ]; then
            echo "ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "ë³€ê²½ì‚¬í•­ì´ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤:"
            git status --short
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi
      
      - name: ğŸ“ ë³€ê²½ì‚¬í•­ ì»¤ë°‹
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "PM Automation Bot"
          
          # ë³€ê²½ëœ íŒŒì¼ë“¤ ì¶”ê°€
          git add docs/pm/
          
          # ì»¤ë°‹ ë©”ì‹œì§€ ìƒì„±
          CURRENT_DATE=$(date +"%Y-%m-%d")
          CURRENT_SPRINT=$(python -c "
          import datetime
          start_date = datetime.datetime(2024, 1, 15)
          current_date = datetime.datetime.now()
          days_diff = (current_date - start_date).days
          sprint_number = (days_diff // 14) + 1
          print(f'Sprint {sprint_number}')
          ")
          
          if [ "${{ github.event.inputs.daily_only }}" == "true" ]; then
            COMMIT_MSG="ğŸ¤– Auto-create daily standup for ${CURRENT_DATE}"
          else
            COMMIT_MSG="ğŸ¤– Auto-update PM documents for ${CURRENT_SPRINT} (${CURRENT_DATE})"
          fi
          
          git commit -m "${COMMIT_MSG}" -m "
          ğŸ“‹ ìë™ ì—…ë°ì´íŠ¸ëœ ë¬¸ì„œ:
          - Task Assignment Matrix
          - Product Backlog Metrics  
          - System State Documentation
          - Daily Standup (if applicable)
          - Sprint Report (if applicable)
          
          ğŸ¤– Generated by PM Automation System
          " || echo "ì»¤ë°‹í•  ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
      
      - name: ğŸš€ ë³€ê²½ì‚¬í•­ í‘¸ì‹œ
        if: steps.check_changes.outputs.has_changes == 'true'
        run: |
          git push origin ${{ github.ref_name }}
      
      - name: ğŸ“Š ì‹¤í–‰ ê²°ê³¼ ìš”ì•½
        run: |
          echo "## ğŸ¤– PM ë¬¸ì„œ ìë™í™” ì‹¤í–‰ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **ì‹¤í–‰ ë‚ ì§œ**: $(date +"%Y-%m-%d %H:%M:%S")" >> $GITHUB_STEP_SUMMARY
          echo "- **ì‹¤í–‰ ëª¨ë“œ**: ${{ github.event.inputs.daily_only == 'true' && 'ì¼ì¼ ìŠ¤íƒ ë“œì—…ë§Œ' || 'ì „ì²´ ë¬¸ì„œ ì—…ë°ì´íŠ¸' }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check_changes.outputs.has_changes }}" == "true" ]; then
            echo "- **ë³€ê²½ì‚¬í•­**: âœ… ìˆìŒ" >> $GITHUB_STEP_SUMMARY
            echo "- **ì»¤ë°‹ í‘¸ì‹œ**: âœ… ì™„ë£Œ" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **ë³€ê²½ì‚¬í•­**: âŒ ì—†ìŒ" >> $GITHUB_STEP_SUMMARY
            echo "- **ì»¤ë°‹ í‘¸ì‹œ**: â­ï¸ ìŠ¤í‚µë¨" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“ ì—…ë°ì´íŠ¸ëœ ë¬¸ì„œ ìœ„ì¹˜" >> $GITHUB_STEP_SUMMARY
          echo "- \`docs/pm/05_development/task_assignment_matrix.md\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`docs/pm/02_requirements/product_backlog.md\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`docs/pm/03_specifications/current_system_state.md\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`docs/pm/06_meetings/daily_standups/daily_standup_$(date +%Y%m%d).md\`" >> $GITHUB_STEP_SUMMARY
          echo "- \`docs/pm/07_reports/sprint_reports/\`" >> $GITHUB_STEP_SUMMARY

  # ì‹¤íŒ¨ ì‹œ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
  notify-on-failure:
    runs-on: ubuntu-latest
    needs: update-pm-docs
    if: failure()
    
    steps:
      - name: ğŸš¨ ì‹¤íŒ¨ ì•Œë¦¼
        run: |
          echo "âŒ PM ë¬¸ì„œ ìë™í™”ê°€ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤."
          echo "ë¡œê·¸ë¥¼ í™•ì¸í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•´ì£¼ì„¸ìš”."
          # ì—¬ê¸°ì— Slack, Discord ë“±ì˜ ì•Œë¦¼ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥